name: Issue Cleaner

on:
  issue_comment:
    types: [created]

jobs:
  clean-comments:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Clean Comments
      uses: actions/github-script@v7
      with:
        script: |
          const github = require('@actions/github');
          
          // Get the comment data
          const comment = github.context.payload.comment;
          const commentBody = comment.body;
          const commentId = comment.id;
          const issueNumber = comment.issue_number;
          
          // Get configuration from secrets
          const botName = process.env.GITHUB_ACTOR || 'lousybot';
          const targetCommand = '@lousybot clear';
          
          // Check if comment contains the cleanup command
          if (commentBody.includes(targetCommand)) {
            console.log('Cleanup command detected, processing...');
            
            // Get all comments on the issue
            const comments = await github.rest.issues.listComments({
              owner: github.context.repo.owner,
              repo: github.context.repo.repo,
              issue_number: issueNumber
            });
            
            let deletedCount = 0;
            
            // Filter and delete comments made by the bot or containing @lousybot
            const commentsToDelete = comments.data.filter(c => {
              const isBotComment = c.user.login === botName;
              const hasBotMention = c.body.includes('@lousybot');
              return isBotComment || hasBotMention;
            });
            
            // Delete the comments
            for (const commentToDelete of commentsToDelete) {
              try {
                await github.rest.issues.deleteComment({
                  owner: github.context.repo.owner,
                  repo: github.context.repo.repo,
                  comment_id: commentToDelete.id
                });
                deletedCount++;
                console.log(`Deleted comment ${commentToDelete.id}`);
              } catch (error) {
                console.error(`Failed to delete comment ${commentToDelete.id}:`, error.message);
              }
            }
            
            // Create a confirmation comment
            const confirmationComment = `ðŸ§¹ Cleanup completed! Deleted ${deletedCount} comment(s).`;
            
            await github.rest.issues.createComment({
              owner: github.context.repo.owner,
              repo: github.context.repo.repo,
              issue_number: issueNumber,
              body: confirmationComment
            });
            
            console.log(`Cleanup completed. Deleted ${deletedCount} comments.`);
          } else {
            console.log('No cleanup command found in comment.');
          }